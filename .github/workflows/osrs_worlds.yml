name: Update OSRS World List

on:
  schedule:
    - cron: "0 * * * *"   # once every hour
  workflow_dispatch:

jobs:
  update-worlds:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests beautifulsoup4 lxml

      - name: Fetch and parse OSRS world list from Wiki
        id: parse
        run: |
          python - <<'EOF'
          import requests, pathlib, sys, os
          from bs4 import BeautifulSoup
          from datetime import datetime, timezone

          url = "https://oldschool.runescape.wiki/w/Server"
          resp = requests.get(url)
          resp.raise_for_status()

          soup = BeautifulSoup(resp.text, "lxml")

          worlds = []
          seen = set()

          # Find all tables with class wikitable
          tables = soup.find_all("table", {"class": "wikitable"})
          if not tables:
              print("ERROR: Could not find any server list tables.")
              sys.exit(1)

          for table in tables:
              for row in table.find_all("tr")[1:]:
                  cells = [c.get_text(strip=True) for c in row.find_all("td")]
                  if len(cells) < 3:
                      continue
                  world = cells[0]
                  if not world.isdigit():
                      continue  # skip non-world rows

                  location = cells[1]
                  type_ = cells[2]

                  line = f"{world} {location} {type_}"
                  if world not in seen:
                      seen.add(world)
                      worlds.append((int(world), line))

          world_count = len(worlds)
          timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%d_%H%M%S_UTC")

          if world_count == 0:
              print("ERROR: No valid worlds found â€” parser failed.")
              sys.exit(1)

          # Sort by world number
          worlds.sort(key=lambda x: x[0])
          lines = [line for _, line in worlds]

          # Write committed file
          out_path = pathlib.Path("worlds.txt")
          out_path.write_text("\n".join(lines) + "\n", encoding="utf-8")

          # Write timestamped snapshot for artifact
          snapshot = pathlib.Path(f"worlds-{timestamp}.txt")
          snapshot.write_text("\n".join(lines) + "\n", encoding="utf-8")

          print(f"[INFO] Wrote {world_count} worlds from Wiki to {out_path} and snapshot {snapshot}")

          github_output = os.environ.get("GITHUB_OUTPUT")
          if github_output:
              with open(github_output, "a") as fh:
                  print(f"world_count={world_count}", file=fh)
                  print(f"timestamp={timestamp}", file=fh)
          EOF

      - name: Commit changes if needed
        run: |
          if [ ! -f worlds.txt ]; then
            echo "worlds.txt missing, nothing to commit"
            exit 0
          elif git diff --quiet worlds.txt; then
            echo "No changes in worlds.txt"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add worlds.txt
          git commit -m "Update OSRS world list: ${{ steps.parse.outputs.world_count }} worlds @ ${{ steps.parse.outputs.timestamp }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload timestamped artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: osrs-worlds-${{ steps.parse.outputs.timestamp }}
          path: worlds-${{ steps.parse.outputs.timestamp }}.txt
          retention-days: 7
